(function(f,l){var e,t=/:([\w\d]+)/g,x=/\?([^#]*)$/,n=function(a){return Array.prototype.slice.call(a)},k=function(a){return Object.prototype.toString.call(a)==="[object Function]"},p=function(a){return Object.prototype.toString.call(a)==="[object Array]"},r=function(a){return decodeURIComponent(a.replace(/\+/g," "))},y=encodeURIComponent,z=function(a){return String(a).replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},q=function(a){return function(b,c){return this.route.apply(this,
[a,b,c])}},u={},A=[];e=function(){var a=n(arguments),b,c;e.apps=e.apps||{};if(a.length===0||a[0]&&k(a[0]))return e.apply(e,["body"].concat(a));else if(typeof(c=a.shift())=="string"){b=e.apps[c]||new e.Application;b.element_selector=c;a.length>0&&f.each(a,function(d,g){b.use(g)});b.element_selector!=c&&delete e.apps[c];return e.apps[b.element_selector]=b}};e.VERSION="0.6.3";e.addLogger=function(a){A.push(a)};e.log=function(){var a=n(arguments);a.unshift("["+Date()+"]");f.each(A,function(b,c){c.apply(e,
a)})};if(typeof l.console!="undefined")k(l.console.log.apply)?e.addLogger(function(){l.console.log.apply(l.console,arguments)}):e.addLogger(function(){l.console.log(arguments)});else typeof console!="undefined"&&e.addLogger(function(){console.log.apply(console,arguments)});f.extend(e,{makeArray:n,isFunction:k,isArray:p});e.Object=function(a){return f.extend(this,a||{})};f.extend(e.Object.prototype,{escapeHTML:z,h:z,toHash:function(){var a={};f.each(this,function(b,c){k(c)||(a[b]=c)});return a},toHTML:function(){var a=
"";f.each(this,function(b,c){k(c)||(a+="<strong>"+b+"</strong> "+c+"<br />")});return a},keys:function(a){var b=[];for(var c in this)if(!k(this[c])||!a)b.push(c);return b},has:function(a){return this[a]&&f.trim(this[a].toString())!=""},join:function(){var a=n(arguments),b=a.shift();return a.join(b)},log:function(){e.log.apply(e,arguments)},toString:function(a){var b=[];f.each(this,function(c,d){if(!k(d)||a)b.push('"'+c+'": '+d.toString())});return"Sammy.Object: {"+b.join(",")+"}"}});e.HashLocationProxy=
function(a,b){this.app=a;this.is_native=false;this._startPolling(b)};e.HashLocationProxy.prototype={bind:function(){var a=this,b=this.app;f(l).bind("hashchange."+this.app.eventNamespace(),function(c,d){if(a.is_native===false&&!d){e.log("native hash change exists, using");a.is_native=true;l.clearInterval(e.HashLocationProxy._interval)}b.trigger("location-changed")});if(!e.HashLocationProxy._bindings)e.HashLocationProxy._bindings=0;e.HashLocationProxy._bindings++},unbind:function(){f(l).unbind("hashchange."+
this.app.eventNamespace());e.HashLocationProxy._bindings--;e.HashLocationProxy._bindings<=0&&l.clearInterval(e.HashLocationProxy._interval)},getLocation:function(){var a=l.location.toString().match(/^[^#]*(#.+)$/);return a?a[1]:""},setLocation:function(a){return l.location=a},_startPolling:function(a){var b=this;if(!e.HashLocationProxy._interval){a||(a=10);var c=function(){var d=b.getLocation();if(!e.HashLocationProxy._last_location||d!=e.HashLocationProxy._last_location)l.setTimeout(function(){f(l).trigger("hashchange",
[true])},0);e.HashLocationProxy._last_location=d};c();e.HashLocationProxy._interval=l.setInterval(c,a)}}};e.Application=function(a){var b=this;this.routes={};this.listeners=new e.Object({});this.arounds=[];this.befores=[];this.namespace=(new Date).getTime()+"-"+parseInt(Math.random()*1E3,10);this.context_prototype=function(){e.EventContext.apply(this,arguments)};this.context_prototype.prototype=new e.EventContext;k(a)&&a.apply(this,[this]);this._location_proxy||this.setLocationProxy(new e.HashLocationProxy(this,
this.run_interval_every));this.debug&&this.bindToAllEvents(function(c,d){b.log(b.toString(),c.cleaned_type,d||{})})};e.Application.prototype=f.extend({},e.Object.prototype,{ROUTE_VERBS:["get","post","put","delete"],APP_EVENTS:["run","unload","lookup-route","run-route","route-found","event-context-before","event-context-after","changed","error","check-form-submission","redirect","location-changed"],_last_route:null,_location_proxy:null,_running:false,element_selector:"body",debug:false,raise_errors:false,
run_interval_every:50,template_engine:null,toString:function(){return"Sammy.Application:"+this.element_selector},$element:function(a){return a?f(this.element_selector).find(a):f(this.element_selector)},use:function(){var a=n(arguments),b=a.shift(),c=b||"";try{a.unshift(this);if(typeof b=="string"){c="Sammy."+b;b=e[b]}b.apply(this,a)}catch(d){if(typeof b==="undefined")this.error("Plugin Error: called use() but plugin ("+c.toString()+") is not defined",d);else k(b)?this.error("Plugin Error",d):this.error("Plugin Error: called use() but '"+
c.toString()+"' is not a function",d)}return this},setLocationProxy:function(a){var b=this._location_proxy;this._location_proxy=a;if(this.isRunning()){b&&b.unbind();this._location_proxy.bind()}},route:function(a,b,c){var d=this,g=[],h,i;if(!c&&k(b)){c=b=a;a="any"}a=a.toLowerCase();if(b.constructor==String){for(t.lastIndex=0;(i=t.exec(b))!==null;)g.push(i[1]);b=new RegExp("^"+b.replace(t,"([^/]+)")+"$")}if(typeof c=="string")c=d[c];h=function(j){var m={verb:j,path:b,callback:c,param_names:g};d.routes[j]=
d.routes[j]||[];d.routes[j].push(m)};a==="any"?f.each(this.ROUTE_VERBS,function(j,m){h(m)}):h(a);return this},get:q("get"),post:q("post"),put:q("put"),del:q("delete"),any:q("any"),mapRoutes:function(a){var b=this;f.each(a,function(c,d){b.route.apply(b,d)});return this},eventNamespace:function(){return["sammy-app",this.namespace].join("-")},bind:function(a,b,c){var d=this;if(typeof c=="undefined")c=b;b=function(g,h){var i;if(h&&h.context){i=h.context;delete h.context}else i=new d.context_prototype(d,
"bind",g.type,h,g.target);g.cleaned_type=g.type.replace(d.eventNamespace(),"");c.apply(i,[g,h])};this.listeners[a]||(this.listeners[a]=[]);this.listeners[a].push(b);this.isRunning()&&this._listen(a,b);return this},trigger:function(a,b){this.$element().trigger([a,this.eventNamespace()].join("."),[b]);return this},refresh:function(){this.last_location=null;this.trigger("location-changed");return this},before:function(a,b){if(k(a)){b=a;a={}}this.befores.push([a,b]);return this},after:function(a){return this.bind("event-context-after",
a)},around:function(a){this.arounds.push(a);return this},isRunning:function(){return this._running},helpers:function(a){f.extend(this.context_prototype.prototype,a);return this},helper:function(a,b){this.context_prototype.prototype[a]=b;return this},run:function(a){if(this.isRunning())return false;var b=this;f.each(this.listeners.toHash(),function(c,d){f.each(d,function(g,h){b._listen(c,h)})});this.trigger("run",{start_url:a});this._running=true;this.last_location=null;this.getLocation()==""&&typeof a!=
"undefined"&&this.setLocation(a);this._checkLocation();this._location_proxy.bind();this.bind("location-changed",function(){b._checkLocation()});this.bind("submit",function(c){return b._checkFormSubmission(f(c.target).closest("form"))===false?c.preventDefault():false});f(l).bind("beforeunload",function(){b.unload()});return this.trigger("changed")},unload:function(){if(!this.isRunning())return false;var a=this;this.trigger("unload");this._location_proxy.unbind();this.$element().unbind("submit").removeClass(a.eventNamespace());
f.each(this.listeners.toHash(),function(b,c){f.each(c,function(d,g){a._unlisten(b,g)})});this._running=false;return this},bindToAllEvents:function(a){var b=this;f.each(this.APP_EVENTS,function(c,d){b.bind(d,a)});f.each(this.listeners.keys(true),function(c,d){b.APP_EVENTS.indexOf(d)==-1&&b.bind(d,a)});return this},routablePath:function(a){return a.replace(x,"")},lookupRoute:function(a,b){var c=this,d=false;this.trigger("lookup-route",{verb:a,path:b});typeof this.routes[a]!="undefined"&&f.each(this.routes[a],
function(g,h){if(c.routablePath(b).match(h.path)){d=h;return false}});return d},runRoute:function(a,b,c,d){var g=this,h=this.lookupRoute(a,b),i,j,m,v,B,w,C;this.log("runRoute",[a,b].join(" "));this.trigger("run-route",{verb:a,path:b,params:c});if(typeof c=="undefined")c={};f.extend(c,this._parseQueryString(b));if(h){this.trigger("route-found",{route:h});if((w=h.path.exec(this.routablePath(b)))!==null){w.shift();f.each(w,function(o,s){if(h.param_names[o])c[h.param_names[o]]=r(s);else{if(!c.splat)c.splat=
[];c.splat.push(r(s))}})}i=new this.context_prototype(this,a,b,c,d);d=this.arounds.slice(0);m=this.befores.slice(0);B=[i].concat(c.splat);j=function(){for(var o;m.length>0;){v=m.shift();if(g.contextMatchesOptions(i,v[0])){o=v[1].apply(i,[i]);if(o===false)return false}}g.last_route=h;i.trigger("event-context-before",{context:i});o=h.callback.apply(i,B);i.trigger("event-context-after",{context:i});return o};f.each(d.reverse(),function(o,s){var D=j;j=function(){return s.apply(i,[D])}});try{C=j()}catch(E){this.error(["500 Error",
a,b].join(" "),E)}return C}else return this.notFound(a,b)},contextMatchesOptions:function(a,b,c){b=b;if(typeof b==="undefined"||b=={})return true;if(typeof c==="undefined")c=true;if(typeof b==="string"||k(b.test))b={path:b};if(b.only)return this.contextMatchesOptions(a,b.only,true);else if(b.except)return this.contextMatchesOptions(a,b.except,false);var d=true,g=true;if(b.path)d=k(b.path.test)?b.path.test(a.path):b.path.toString()===a.path;if(b.verb)g=b.verb===a.verb;return c?g&&d:!(g&&d)},getLocation:function(){return this._location_proxy.getLocation()},
setLocation:function(a){return this._location_proxy.setLocation(a)},swap:function(a){return this.$element().html(a)},templateCache:function(a,b){return typeof b!="undefined"?(u[a]=b):u[a]},clearTemplateCache:function(){return u={}},notFound:function(a,b){b=this.error(["404 Not Found",a,b].join(" "));return a==="get"?b:true},error:function(a,b){b||(b=new Error);b.message=[a,b.message].join(" ");this.trigger("error",{message:b.message,error:b});if(this.raise_errors)throw b;else this.log(b.message,b)},
_checkLocation:function(){var a,b;a=this.getLocation();if(!this.last_location||this.last_location[0]!="get"||this.last_location[1]!=a){this.last_location=["get",a];b=this.runRoute("get",a)}return b},_getFormVerb:function(a){a=f(a);var b,c;c=a.find('input[name="_method"]');if(c.length>0)b=c.val();b||(b=a[0].getAttribute("method"));if(!b||b=="")b="get";return f.trim(b.toString().toLowerCase())},_checkFormSubmission:function(a){var b,c,d;this.trigger("check-form-submission",{form:a});b=f(a);c=b.attr("action");
d=this._getFormVerb(b);this.log("_checkFormSubmission",b,c,d);if(d==="get"){this.setLocation(c+"?"+this._serializeFormParams(b));a=false}else{b=f.extend({},this._parseFormParams(b));a=this.runRoute(d,c,b,a.get(0))}return typeof a=="undefined"?false:a},_serializeFormParams:function(a){var b="";a=a.serializeArray();var c;if(a.length>0){b=this._encodeFormPair(a[0].name,a[0].value);for(c=1;c<a.length;c++)b=b+"&"+this._encodeFormPair(a[c].name,a[c].value)}return b},_encodeFormPair:function(a,b){return y(a)+
"="+y(b)},_parseFormParams:function(a){var b={};a=a.serializeArray();var c;for(c=0;c<a.length;c++)b=this._parseParamPair(b,a[c].name,a[c].value);return b},_parseQueryString:function(a){var b={},c,d;if(a=a.match(x)){a=a[1].split("&");for(d=0;d<a.length;d++){c=a[d].split("=");b=this._parseParamPair(b,r(c[0]),r(c[1]||""))}}return b},_parseParamPair:function(a,b,c){if(a[b])if(p(a[b]))a[b].push(c);else a[b]=[a[b],c];else a[b]=c;return a},_listen:function(a,b){return this.$element().bind([a,this.eventNamespace()].join("."),
b)},_unlisten:function(a,b){return this.$element().unbind([a,this.eventNamespace()].join("."),b)}});e.RenderContext=function(a){this.event_context=a;this.callbacks=[];this.content=this.previous_content=null;this.waiting=this.next_engine=false};e.RenderContext.prototype=f.extend({},e.Object.prototype,{then:function(a){if(!k(a))if(typeof a==="string"&&a in this.event_context){var b=this.event_context[a];a=function(d){return b.apply(this.event_context,[d])}}else return this;var c=this;if(this.waiting)this.callbacks.push(a);
else{this.wait();l.setTimeout(function(){var d=a.apply(c,[c.content,c.previous_content]);d!==false&&c.next(d)},0)}return this},wait:function(){this.waiting=true},next:function(a){this.waiting=false;if(typeof a!=="undefined"){this.previous_content=this.content;this.content=a}this.callbacks.length>0&&this.then(this.callbacks.shift())},load:function(a,b,c){var d=this;return this.then(function(){var g,h,i;if(k(b)){c=b;b={}}else b=f.extend({},b);c&&this.then(c);if(typeof a==="string"){g=(i=a.match(/\.json$/)||
b.json)&&b.cache===true||b.cache!==false;d.next_engine=d.event_context.engineFor(a);delete b.cache;delete b.json;if(b.engine){d.next_engine=b.engine;delete b.engine}if(g&&(h=this.event_context.app.templateCache(a)))return h;this.wait();f.ajax(f.extend({url:a,data:{},dataType:i?"json":null,type:"get",success:function(j){g&&d.event_context.app.templateCache(a,j);d.next(j)}},b));return false}else{if(a.nodeType)return a.innerHTML;if(a.selector){d.next_engine=a.attr("data-engine");return b.clone===false?
a.remove()[0].innerHTML.toString():a[0].innerHTML.toString()}}})},render:function(a,b,c){return k(a)&&!b?this.then(a):this.load(a).interpolate(b,a).then(c)},partial:function(a,b){return this.render(a,b).swap()},send:function(){var a=this,b=n(arguments),c=b.shift();if(p(b[0]))b=b[0];return this.then(function(){b.push(function(d){a.next(d)});a.wait();c.apply(c,b);return false})},collect:function(a,b,c){var d=this,g=function(){if(k(a)){b=a;a=this.content}var h=[],i=false;f.each(a,function(j,m){j=b.apply(d,
[j,m]);if(j.jquery&&j.length==1){j=j[0];i=true}h.push(j);return j});return i?h:h.join("")};return c?g():this.then(g)},renderEach:function(a,b,c,d){if(p(b)){d=c;c=b;b=null}return this.load(a).then(function(g){var h=this;c||(c=p(this.previous_content)?this.previous_content:[]);if(d)f.each(c,function(i,j){i={};var m=this.next_engine||a;b?(i[b]=j):(i=j);d(j,h.event_context.interpolate(g,i,m))});else return this.collect(c,function(i,j){i={};var m=this.next_engine||a;b?(i[b]=j):(i=j);return this.event_context.interpolate(g,
i,m)},true)})},interpolate:function(a,b,c){var d=this;return this.then(function(g,h){if(!a&&h)a=h;if(this.next_engine){b=this.next_engine;this.next_engine=false}g=d.event_context.interpolate(g,a,b);return c?h+g:g})},swap:function(){return this.then(function(a){this.event_context.swap(a)}).trigger("changed",{})},appendTo:function(a){return this.then(function(b){f(a).append(b)}).trigger("changed",{})},prependTo:function(a){return this.then(function(b){f(a).prepend(b)}).trigger("changed",{})},replace:function(a){return this.then(function(b){f(a).html(b)}).trigger("changed",
{})},trigger:function(a,b){return this.then(function(c){if(typeof b=="undefined")b={content:c};this.event_context.trigger(a,b)})}});e.EventContext=function(a,b,c,d,g){this.app=a;this.verb=b;this.path=c;this.params=new e.Object(d);this.target=g};e.EventContext.prototype=f.extend({},e.Object.prototype,{$element:function(){return this.app.$element(n(arguments).shift())},engineFor:function(a){var b;if(k(a))return a;a=(a||this.app.template_engine).toString();if(b=a.match(/\.([^\.\?\#]+)/))a=b[1];if(a&&
k(this[a]))return this[a];if(this.app.template_engine)return this.engineFor(this.app.template_engine);return function(c){return c}},interpolate:function(a,b,c){return this.engineFor(c).apply(this,[a,b])},render:function(a,b,c){return(new e.RenderContext(this)).render(a,b,c)},renderEach:function(a,b,c,d){return(new e.RenderContext(this)).renderEach(a,b,c,d)},load:function(a,b,c){return(new e.RenderContext(this)).load(a,b,c)},partial:function(a,b){return(new e.RenderContext(this)).partial(a,b)},send:function(){var a=
new e.RenderContext(this);return a.send.apply(a,arguments)},redirect:function(){var a;a=n(arguments);var b=this.app.getLocation();if(a.length>1){a.unshift("/");a=this.join.apply(this,a)}else a=a[0];this.trigger("redirect",{to:a});this.app.last_location=[this.verb,this.path];this.app.setLocation(a);b==a&&this.app.trigger("location-changed")},trigger:function(a,b){if(typeof b=="undefined")b={};if(!b.context)b.context=this;return this.app.trigger(a,b)},eventNamespace:function(){return this.app.eventNamespace()},
swap:function(a){return this.app.swap(a)},notFound:function(){return this.app.notFound(this.verb,this.path)},json:function(a){return f.parseJSON(a)},toString:function(){return"Sammy.EventContext: "+[this.verb,this.path,this.params].join(" ")}});define(["jquery"],function(){return e})})(jQuery,window);